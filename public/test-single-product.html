<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Single Product API</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #1d4ed8;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.4;
    }
    .success { color: #10b981; font-weight: bold; }
    .error { color: #ef4444; font-weight: bold; }
    .info { color: #3b82f6; font-weight: bold; }
    input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      width: 400px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>üîç GKV API - Single Product Test</h1>
  <p>Test fetching a single product by its UUID to find where "Merkmale" data comes from</p>

  <div class="section">
    <h2>Test Product Search</h2>
    <div>
      <label>
        <strong>Product Number (zehnSteller):</strong><br>
        <input type="text" id="productNumber" value="10.46.01.1014" placeholder="e.g., 10.46.01.1014">
      </label>
      <button onclick="testProductByNumber()">Search by Number</button>
    </div>
    <p><small>Default: 10.46.01.1014 (Gehgestell mit Merkmale)</small></p>
    <hr style="margin: 20px 0;">
    <div>
      <label>
        <strong>Or try Product UUID (probably won't work):</strong><br>
        <input type="text" id="productId" value="069e00ed-ce41-4279-ab9f-fe9bf563e8fb" placeholder="Enter UUID">
      </label>
      <button onclick="testProductById()">Fetch by UUID</button>
    </div>
  </div>

  <div class="section">
    <h2>Test Results</h2>
    <div id="results"></div>
  </div>

  <script>
    // Use our proxy to avoid CORS issues
    const PROXY_BASE = '/api/proxy';
    
    function encodeProxyPath(apiPath) {
      return `${PROXY_BASE}?path=${encodeURIComponent(apiPath)}`;
    }

    async function testProductByNumber() {
      const productNumber = document.getElementById('productNumber').value.trim();
      const resultsDiv = document.getElementById('results');
      
      resultsDiv.innerHTML = '<p class="info">‚è≥ Searching for product...</p>';

      try {
        // Search in the product list by zehnSteller
        const apiPath = `api/verzeichnis/Produkt?produktgruppennummer=${productNumber.substring(0, 5)}&take=1000`;
        const endpoint = encodeProxyPath(apiPath);
        
        console.log('Searching with API path:', apiPath, '‚Üí', endpoint);
        const res = await fetch(endpoint);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('API response:', data);
        
        // Extract products array
        const products = Array.isArray(data) ? data : data.value || [];
        console.log('Total products returned:', products.length);
        
        // Find the product with matching zehnSteller or nummer
        const product = products.find(p => 
          p.zehnSteller === productNumber || 
          p.nummer === productNumber ||
          p.nummer === productNumber.replace(/\./g, '')
        );
        
        if (product) {
          console.log('Found product:', product);
          displayProductDetails({ value: [product] }, `Found in product list (${products.length} searched)`);
        } else {
          resultsDiv.innerHTML = `
            <p class="error">‚ùå Product ${productNumber} not found</p>
            <p>Searched ${products.length} products in category ${productNumber.substring(0, 5)}</p>
            <p>üí° Try checking the product number or searching a broader category.</p>
          `;
        }
        
      } catch (error) {
        resultsDiv.innerHTML = `
          <p class="error">‚ùå Error: ${error.message}</p>
          <pre>${error.stack}</pre>
        `;
      }
    }

    async function testProductById() {
      const productId = document.getElementById('productId').value.trim();
      const resultsDiv = document.getElementById('results');
      
      resultsDiv.innerHTML = '<p class="info">‚è≥ Fetching product...</p>';

      try {
        // Try different possible API paths (through our proxy)
        const apiPaths = [
          `api/verzeichnis/Produkt/${productId}`,
          `api/verzeichnis/Produkt?id=${productId}`,
          `api/verzeichnis/Produkt?produktId=${productId}`,
        ];
        
        const endpoints = apiPaths.map(path => encodeProxyPath(path));

        let success = false;
        let response;
        let usedApiPath;

        for (let i = 0; i < endpoints.length; i++) {
          const endpoint = endpoints[i];
          const apiPath = apiPaths[i];
          
          try {
            console.log('Trying API path:', apiPath, '‚Üí', endpoint);
            const res = await fetch(endpoint);
            
            if (res.ok) {
              const data = await res.json();
              console.log('Success with:', apiPath, data);
              
              response = data;
              usedApiPath = apiPath;
              success = true;
              break;
            } else {
              console.log(`Failed (${res.status}):`, apiPath);
            }
          } catch (e) {
            console.log('Error with:', apiPath, e.message);
          }
        }

        if (success) {
          displayProductDetails(response, usedApiPath);
        } else {
          resultsDiv.innerHTML = `
            <p class="error">‚ùå All endpoints failed!</p>
            <p>Tried (via proxy):</p>
            <ul>
              ${apiPaths.map(path => `<li><code>${path}</code></li>`).join('')}
            </ul>
            <p>üí° The API might not support single product queries, or the UUID is in a different format.</p>
          `;
        }

      } catch (error) {
        resultsDiv.innerHTML = `
          <p class="error">‚ùå Error: ${error.message}</p>
          <pre>${error.stack}</pre>
        `;
      }
    }

    function displayProductDetails(data, apiPath) {
      const resultsDiv = document.getElementById('results');
      
      // Extract product (might be wrapped in 'value' array)
      const product = Array.isArray(data) ? data[0] : 
                      data.value ? data.value[0] : 
                      data;

      if (!product) {
        resultsDiv.innerHTML = '<p class="error">‚ùå No product data found in response</p>';
        return;
      }

      // Look for all possible field names that might contain "Merkmale"
      const allFields = Object.keys(product);
      const merkmaleRelatedFields = allFields.filter(field => 
        field.toLowerCase().includes('merkmal') ||
        field.toLowerCase().includes('feature') ||
        field.toLowerCase().includes('eigenschaften') ||
        field.toLowerCase().includes('komponente') ||
        field.toLowerCase().includes('beschreibung') ||
        field.toLowerCase().includes('erlaeuterung') ||
        field.toLowerCase().includes('detail') ||
        field.toLowerCase().includes('spezifikation')
      );

      resultsDiv.innerHTML = `
        <p class="success">‚úÖ Product fetched successfully!</p>
        <p><strong>API path used:</strong> <code>${apiPath}</code></p>
        <p><small style="color: #666;">Requested via proxy to avoid CORS</small></p>
        <hr>
        
        <h3>üìä Product Information</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Name:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${product.name || product.displayName || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Nummer:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${product.nummer || product.zehn_steller || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>ID:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${product.id || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Hersteller:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${product.herstellerName || 'N/A'}</td></tr>
        </table>
        
        <hr>
        
        <h3>üîç Fields Related to "Merkmale" (${merkmaleRelatedFields.length})</h3>
        ${merkmaleRelatedFields.length > 0 ? `
          <table style="width: 100%; border-collapse: collapse;">
            ${merkmaleRelatedFields.map(field => `
              <tr>
                <td style="padding: 8px; border: 1px solid #ddd; width: 30%; font-weight: bold; background: #f9fafb;">${field}</td>
                <td style="padding: 8px; border: 1px solid #ddd; word-break: break-word;">${formatValue(product[field])}</td>
              </tr>
            `).join('')}
          </table>
        ` : '<p class="error">‚ùå No merkmale-related fields found!</p>'}
        
        <hr>
        
        <h3>üìã All Available Fields (${allFields.length})</h3>
        <details>
          <summary style="cursor: pointer; padding: 10px; background: #f3f4f6; border-radius: 4px; margin-bottom: 10px;">
            Click to expand full field list
          </summary>
          <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            ${allFields.map(field => `
              <tr>
                <td style="padding: 8px; border: 1px solid #ddd; width: 30%; font-weight: bold; background: #f9fafb;">${field}</td>
                <td style="padding: 8px; border: 1px solid #ddd; word-break: break-word;">${formatValue(product[field])}</td>
              </tr>
            `).join('')}
          </table>
        </details>
        
        <hr>
        
        <h3>üìÑ Complete JSON Response</h3>
        <details>
          <summary style="cursor: pointer; padding: 10px; background: #f3f4f6; border-radius: 4px; margin-bottom: 10px;">
            Click to expand raw JSON
          </summary>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        </details>
      `;
    }

    function formatValue(value) {
      if (value === null || value === undefined) return '<em style="color: #999;">null</em>';
      if (value === '') return '<em style="color: #999;">empty string</em>';
      if (typeof value === 'boolean') return value ? '‚úÖ true' : '‚ùå false';
      if (Array.isArray(value)) {
        if (value.length === 0) return '<em style="color: #999;">empty array []</em>';
        return `<strong>[Array: ${value.length} items]</strong><br><pre style="margin: 5px 0; padding: 5px; background: #f9fafb;">${JSON.stringify(value, null, 2)}</pre>`;
      }
      if (typeof value === 'object') {
        return `<strong>{Object}</strong><br><pre style="margin: 5px 0; padding: 5px; background: #f9fafb;">${JSON.stringify(value, null, 2)}</pre>`;
      }
      if (typeof value === 'string' && value.length > 100) {
        return `<span style="color: #059669; font-weight: bold;">[String: ${value.length} chars]</span><br>${value.substring(0, 200)}${value.length > 200 ? '...' : ''}`;
      }
      return value;
    }

    // Auto-run test on load
    window.onload = () => {
      console.log('Ready! Click "Fetch Product" to test.');
    };
  </script>
</body>
</html>

